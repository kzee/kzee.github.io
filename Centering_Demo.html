<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Within- and Between-Subject Centering</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 64px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 69px;
  margin-top: -69px;
}

.section h2 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h3 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h4 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h5 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h6 {
  padding-top: 69px;
  margin-top: -69px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Katherine S. Zee</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="research.html">Research</a>
</li>
<li>
  <a href="publications.html">Publications</a>
</li>
<li>
  <a href="teaching.html">Teaching</a>
</li>
<li>
  <a href="rcode.html">R Code</a>
</li>
<li>
  <a href="resources.html">Resources</a>
</li>
<li>
  <a href="files/KatherineZeeCV.pdf">CV</a>
</li>
<li>
  <a href="contact.html">Contact</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Within- and Between-Subject Centering</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#load-packages-data-set">Load Packages &amp; Data set</a></li>
<li><a href="#method-1-base-r">Method 1: Base R</a></li>
<li><a href="#method-2-dplyr">Method 2: <code>dplyr</code></a></li>
<li><a href="#method-3-bmlm-helper-function">Method 3: <code>bmlm</code> Helper Function</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
</div>

<p><font size="3"></p>
<p><br></p>
<div id="overview" class="section level1">
<h1>Overview</h1>
<p>This guide demonstrates how to perform within- and between-subject centering of variables in R. This is an important step in prepping data for a multilevel analysis, as there are both within- and between-subject differences that need to be separated.</p>
<p>To complete this demo, we will use the Bolger &amp; Laurenceau Chapter 9 data, which we can access through the <code>bmlm</code> package. This dataset already contains within-person centered variables, but we will compute them ourselves anyway.</p>
<p><br></p>
</div>
<div id="load-packages-data-set" class="section level1">
<h1>Load Packages &amp; Data set</h1>
<pre class="r"><code>library(bmlm)
library(dplyr)</code></pre>
<pre class="r"><code>d &lt;- BLch9</code></pre>
<p><br></p>
</div>
<div id="method-1-base-r" class="section level1">
<h1>Method 1: Base R</h1>
<p>The first method involves using functions available in base R. With the <code>within</code> approach, we will create a new variable that draws on information nested in a particular group, <code>id</code> in this case. We then specify the function we want to apply, in this case taking the mean. Note that if our dataset had missing values (<code>NA</code>), we might want to define a new function ourselves for taking the mean but excluding the missing values.</p>
<pre class="r"><code>d &lt;- within(d, {fwkstrs_mean1 = ave(fwkstrs, id, FUN = mean)})
d$fwkstrs_cw1 &lt;- d$fwkstrs - d$fwkstrs_mean1
d$fwkstrs_cb1 &lt;- scale(d$fwkstrs, center = T, scale = F) - d$fwkstrs_cw1

d &lt;- within(d, {fwkdis_mean1 = ave(fwkdis, id, FUN = mean)})
d$fwkdis_cw1 &lt;- d$fwkdis - d$fwkdis_mean1
d$fwkdis_cb1 &lt;- scale(d$fwkdis, center = T, scale = F) - d$fwkdis_cw1</code></pre>
<p><br></p>
<p>Now, let’s check our work (for the sake of space we will just look at the <code>fwkstrs</code> variable):</p>
<pre class="r"><code>head(dplyr::select(d, id, time, fwkstrs, fwkstrs_cw1, fwkstrs_cb1)) </code></pre>
<pre><code>##    id time fwkstrs fwkstrs_cw1 fwkstrs_cb1
## 1 101    1       3   0.3333333  -0.3019048
## 2 101    2       3   0.3333333  -0.3019048
## 3 101    3       3   0.3333333  -0.3019048
## 4 101    4       4   1.3333333  -0.3019048
## 5 101    5       1  -1.6666667  -0.3019048
## 6 101    6       2  -0.6666667  -0.3019048</code></pre>
<p><br></p>
</div>
<div id="method-2-dplyr" class="section level1">
<h1>Method 2: <code>dplyr</code></h1>
<p>A second method involves using the <code>dplyr</code> package. With the <code>group_by</code> function, we can ask R to take the mean for each “group”, which in this case is each person.</p>
<p>In the first part of the code, we will group our dataframe by <code>id</code>. This will effectively treat each “group” (person) as their own dataframe. By taking the mean, we will generate a person-specific mean. This can be accomplished using <code>mutate()</code>, which is a function that allows you to create new variables. For details, run <code>?mutate</code>. We will obtain person-specific means for two variables: <code>fwkstrs</code> and <code>fwkdis</code>.</p>
<p>Next, we need to <code>ungroup()</code> so that our data manipulation will be on the whole dataframe, and not on the data broken up by <code>id</code>.</p>
<p>We will then use <code>mutate()</code> again to create three new sets of variables: (A) Grand-mean centered versions of each of our variables, (B) Within-person centered versions of each of our variables, and (C) Between-person centered versions of each of our varaibles.</p>
<ol style="list-style-type: upper-alpha">
<li><p>Grand-mean centered: We will use the <code>scale()</code> function, which is a base R function for centering and standardizing variables. Because we want to keep our variable in the original units (i.e., we do NOT want standardized versions), we will set <code>center = T</code> and <code>scale = F</code> within the function. This will simply subtract out the grand mean (mean of all observations) from each individual observation in the dataframe.</p></li>
<li><p>Within-person centered: Next, we will create within-person centered variables, which capture fluctuations relative to each person’s own average across the study period. Do to this, we will simply take the “raw” observation for each variable and subtract out the person-specific mean we computed in the first part.</p></li>
<li><p>Between-person centered: Finally, we will create between-person centered variables, which reflect between-person differences in level across the study period (i.e., whether a particular subject reported generally high vs. low levels of each variable across the study period). As noted in Chapter 5 of <a href="">Bolger &amp; Laurenceau (2013)</a>, within-person centered value + between-person centered value = grand mean centered value. Therefore, we can obtain between-person centered values by subtracting within-person centered values from grand mean centered values.</p></li>
</ol>
<pre class="r"><code>d &lt;- d %&gt;% group_by(id) %&gt;% 
  mutate(
    fwkstrs_mean2 = mean(fwkstrs, na.rm = T),
    fwkdis_mean2 = mean(fwkdis, na.rm = T)
  ) %&gt;% ungroup() %&gt;% 
  mutate(
    fwkstrs_c2 = scale(fwkstrs, center = T, scale = F),
    fwkdis_c2 = scale(fwkdis, center = T, scale = F),
    
    fwkstrs_cw2 = fwkstrs - fwkstrs_mean2,
    fwkdis_cw2 = fwkdis - fwkdis_mean2,

    fwkstrs_cb2 = fwkstrs_c2 - fwkstrs_cw2,
    fwkdis_cb2 = fwkdis_c2 - fwkdis_cw2
  )</code></pre>
<p><br></p>
<p>Now, let’s check our work:</p>
<pre class="r"><code>head(dplyr::select(d, id, time, fwkstrs, fwkstrs_cw2, fwkstrs_cb2))</code></pre>
<pre><code>## # A tibble: 6 x 5
##      id  time fwkstrs fwkstrs_cw2 fwkstrs_cb2[,1]
##   &lt;int&gt; &lt;int&gt;   &lt;int&gt;       &lt;dbl&gt;           &lt;dbl&gt;
## 1   101     1       3       0.333          -0.302
## 2   101     2       3       0.333          -0.302
## 3   101     3       3       0.333          -0.302
## 4   101     4       4       1.33           -0.302
## 5   101     5       1      -1.67           -0.302
## 6   101     6       2      -0.667          -0.302</code></pre>
<p><br></p>
</div>
<div id="method-3-bmlm-helper-function" class="section level1">
<h1>Method 3: <code>bmlm</code> Helper Function</h1>
<p>A third option is to use the <code>isolate</code> function from the <code>bmlm</code> package. This will accomplish your centering needs in a single step.</p>
<p>As shown in the code below, we simply need to enter our dataframe (<code>d</code>), the name of our grouping variable (<code>id</code>), and the variables we want to center (<code>fwkstrs</code> and <code>fwkdis</code>). The <code>which</code> argument refers to whether you want the function to return only within-person centered values, only between-person centered values, or both. Here, we have specified <code>both</code>.</p>
<pre class="r"><code>d &lt;- isolate(d, by = &quot;id&quot;,
             value = c(&quot;fwkstrs&quot;, &quot;fwkdis&quot;),
             which = &quot;both&quot;)</code></pre>
<p><br></p>
<p>Now, let’s check our work (note that <code>isolate</code> does not provide the grand mean version):</p>
<pre class="r"><code>head(dplyr::select(d, id, time, fwkstrs, fwkstrs_cw, fwkstrs_cb)) </code></pre>
<pre><code>## # A tibble: 6 x 5
##      id  time fwkstrs fwkstrs_cw fwkstrs_cb
##   &lt;int&gt; &lt;int&gt;   &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
## 1   101     1       3      0.333     -0.302
## 2   101     2       3      0.333     -0.302
## 3   101     3       3      0.333     -0.302
## 4   101     4       4      1.33      -0.302
## 5   101     5       1     -1.67      -0.302
## 6   101     6       2     -0.667     -0.302</code></pre>
<p><br></p>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<p>As you can see, there are multiple ways of getting us to the same place. I don’t think any single method is necessarily “best”, although a case could be made for the utility of Method 3, as a prepared function can help eliminate coding errors. However, there may be cases when one needs to center on a value other than the mean (e.g., baseline). In such cases, the other methods may provide the flexibility necessary for doing so.</p>
<p></font></p>
<p><br></p>
<p><font size="2"> <em><a href="/Users/zeekatherine/Desktop/WorkSchool/kzee.github.io/Centering_Demo.Rmd" target="_blank">View .Rmd source code</a></em> </font> <br> <font size="2"> <em>updated April 22, 2019</em> </font></p>
<p><br></p>
<p><font size="2"></p>
 
<hr />
<!--  <p> Copyright &copy; 2019 Katherine S. Zee. All rights reserved. </p>   -->
<p style="text-align: center;">
<span style="color: #808080;"><em><a href="mailto:kzee@psych.columbia.edu">kzee@psych.columbia.edu</a></em></span>
</p>
<p></font></p>
<!-- Add icon library -->
<p><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"></p>
<p><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"></p>
<p><link rel="stylesheet" href="https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css"></p>
<!-- Add font awesome icons -->
<p style="text-align: center;">
<a href="https://twitter.com/KatherineZee?lang=en/" target="_blank" class="fab fa-twitter"></a> <a href="https://github.com/kzee/" target="_blank" class="fab fa-github"></a> <a href="https://osf.io/g579q" target="_blank" class="ai ai-osf ai-1x"></a> <a href="https://www.researchgate.net/profile/Katherine_Zee" target="_blank" class="fab fa-researchgate"></a>
</p>
<font size="2">
<p style="text-align: center;">
<span style="color: #808080;">The material above reflects the best of my knowledge on this topic. Please be sure to check your results and code carefully.</span>
</p>
<p></font></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
